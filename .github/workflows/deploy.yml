name: Build and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Google Auth
      id: auth
      uses: 'google-github-actions/auth@v1'
      with:
        credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

    - name: Set up Cloud SDK
      uses: 'google-github-actions/setup-gcloud@v1'

    - name: Configure Docker
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: Build and Push Docker Image
      env:
        PROJECT_ID: ${{ steps.auth.outputs.project_id }}
        REPO_NAME: url-analytics-repo
        IMAGE_NAME: app
      run: |
        docker build -t us-central1-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME:latest ./app
        docker push us-central1-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME:latest

    - name: Deploy to VM via SSH
      uses: appleboy/ssh-action@master
      env:
        PROJECT_ID: ${{ steps.auth.outputs.project_id }}
        REPO_NAME: url-analytics-repo
        IMAGE_NAME: app
      with:
        host: ${{ secrets.VM_IP }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        envs: PROJECT_ID,REPO_NAME,IMAGE_NAME
        script: |
          # Create app directory if not exists
          mkdir -p ~/app/elk/kibana
          mkdir -p ~/app/elk/logstash
          
          # Authenticate Docker
          gcloud auth configure-docker us-central1-docker.pkg.dev --quiet
          
          # Create .env file for Docker Compose
          echo "PROJECT_ID=$PROJECT_ID" > ~/app/.env
          
          # Pull latest images
          cd ~/app
          docker-compose -f docker-compose.prod.yml pull
          
          # Restart services
          docker-compose -f docker-compose.prod.yml up -d --remove-orphans
          
          # Cleanup unused images
          docker image prune -f

    - name: Copy Configs to VM
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VM_IP }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "docker-compose.prod.yml,elk/"
        target: "~/app"
